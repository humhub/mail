humhub.module("mail.ConversationView",function(r,t,i){var s=t("ui.widget").Widget,a=t("ui.loader"),c=t("client"),o=t("ui.additions"),e=t("util.object"),n=t("mail.notification"),l=t("ui.view"),u=s.extend();u.prototype.init=function(){o.observe(this.$);var e=this;window.onresize=function(t){e.updateSize(!0)},this.getActiveMessageId()||this.setActiveMessageId(s.instance("#inbox").getFirstMessageId()),this.reload(),this.$.on("mouseenter",".mail-conversation-entry",function(){i(this).find(".conversation-menu").show()}).on("mouseleave",".mail-conversation-entry",function(){i(this).find(".conversation-menu").hide()})},u.prototype.loader=function(t){!1!==t?a.set(this.$):a.reset(this.$)},u.prototype.markSeen=function(t){c.post(this.options.markSeenUrl,{data:{id:t}}).then(function(t){e.isDefined(t.messageCount)&&n.setMailMessageCount(t.messageCount)}).catch(function(t){r.log.error(t)})},u.prototype.loadUpdate=function(){var t=this.$.find(".mail-conversation-entry:not(.own):last").data("entry-id"),t={id:this.getActiveMessageId(),from:t},e=this;c.get(this.options.loadUpdateUrl,{data:t}).then(function(t){t.html&&i(t.html).each(function(){e.appendEntry(i(this))})})},u.prototype.reply=function(e){var o=this;c.submit(e).then(function(t){t.success?o.appendEntry(t.content).then(function(){o.$.find(".time").timeago();var t=o.getReplyRichtext();t&&t.$.trigger("clear"),o.scrollToBottom(),l.isSmall()||o.focus(),s.instance("#inbox").updateEntries([o.getActiveMessageId()]),o.setLivePollInterval()}):r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)}).finally(function(t){a.reset(i(".reply-button")),e.finish()})},u.prototype.setLivePollInterval=function(){t("live").setDelay(5)},u.prototype.getReplyRichtext=function(){return s.instance(this.$.find(".ProsemirrorEditor"))},u.prototype.focus=function(t){var e=this.getReplyRichtext();e&&e.focus()},u.prototype.canLoadMore=function(){return!this.options.isLast},u.prototype.reload=function(){this.getActiveMessageId()&&this.loadMessage(this.getActiveMessageId())},u.prototype.addUser=function(t){var e=this;c.submit(t).then(function(t){t.result?e.$.find("#mail-conversation-header").html(t.result):t.error&&r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)})},u.prototype.appendEntry=function(t){var o,n=this,t=i(t);return n.$.find('[data-entry-id="'+t.data("entryId")+'"]').length?Promise.resolve():((o=t.not("script, link").filter(function(){return 1===this.nodeType})).css("opacity",0),this.getListNode().append(t),new Promise(function(t,e){o.css("opacity",1).fadeIn("fast",function(){n.onUpdate(),setTimeout(function(){n.scrollToBottom()},100),t()})}))},u.prototype.loadMessage=function(o){var n=e.isNumber(o)?o:o.$trigger.data("message-id"),i=this;this.loader(),c.get(this.options.loadMessageUrl,{data:{id:n}}).then(function(t){i.setActiveMessageId(n),i.options.isLast=!1;var e=s.instance("#inbox");return e.updateActiveItem(),e.hide(),o.$trigger&&history&&history.replaceState&&(e=o.$trigger.data("action-url"))&&history.replaceState(null,null,e),i.$.css("visibility","hidden"),i.updateContent(t.html)}).then(function(){return i.initScroll()}).catch(function(t){r.log.error(t,!0)}).finally(function(){i.loader(!1),i.$.css("visibility","visible"),i.initReplyRichText()})},u.prototype.initReplyRichText=function(){var t,e,o=this;window.ResizeObserver&&(t=new ResizeObserver(function(t){o.updateSize(o.isScrolledToBottom(100))}),e=o.getReplyRichtext())&&t.observe(e.$[0]),o.focus()},u.prototype.isScrolledToBottom=function(t){if(!this.getListNode().length)return!1;t=t||0;var e=this.getListNode()[0];return e.scrollHeight-e.offsetHeight-e.scrollTop<=t},u.prototype.initScroll=function(){var e,t,o,n;if(window.IntersectionObserver)return e=this.getListNode(),t=i('<div class="conversation-stream-end"></div>'),e.prepend(t),o=this,n=new IntersectionObserver(function(t){o.preventScrollLoading()||t.length&&t[0].isIntersecting&&(a.prepend(e),o.loadMore().finally(function(){a.reset(e)}))},{root:e[0],rootMargin:"50px"}),this.assureScroll().then(function(){n.observe(t[0]),l.isLarge()&&(o.getListNode().niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:0,left:0,bottom:0}}),o.scrollDownButton=void 0,o.getListNode().on("scroll",()=>o.getScrollDownButton().toggle(!o.isScrolledToBottom())))})},u.prototype.getScrollDownButton=function(){return"object"!=typeof this.scrollDownButton&&(this.scrollDownButton=i("<div>").addClass("conversation-scroll-down-button").html('<i class="fa fa-caret-down"></i>').on("click",()=>this.scrollToBottom()),this.getListNode().append(this.scrollDownButton)),this.scrollDownButton},u.prototype.loadMore=function(){var o=this,t={id:this.getActiveMessageId(),from:this.$.find(".mail-conversation-entry:first").data("entryId")};return c.get(this.options.loadMoreUrl,{data:t}).then(function(t){var e;t.result&&(e=i(t.result).hide(),o.getListNode().find(".conversation-stream-end").after(e),e.fadeIn()),o.options.isLast=!t.result||t.isLast}).catch(function(t){r.log.error(t,!0)})},u.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},u.prototype.canLoadMore=function(){return!this.options.isLast},u.prototype.assureScroll=function(){var t=this,e=this.getListNode();return e[0].offsetHeight>=e[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()}):t.scrollToBottom()},u.prototype.updateContent=function(e){var o=this;return new Promise(function(t){o.$.html(e),t()})},u.prototype.getActiveMessageId=function(){return this.options.messageId},u.prototype.setActiveMessageId=function(t){this.options.messageId=t},u.prototype.scrollToBottom=function(){var o=this;return new Promise(function(e){setTimeout(function(){o.$.imagesLoaded(function(){var t=o.getListNode();t.length&&o.updateSize(!1).then(function(){t[0].scrollTop=t[0].scrollHeight,e()})})})})},u.prototype.updateSize=function(i){var r=this;return new Promise(function(n){setTimeout(function(){var t,e,o=r.getListNode();o.length&&(t=(t=r.getReplyRichtext())?t.$.innerHeight():0,o.css("margin-bottom",t+5+"px"),e=r.getListNode().offset().top,e=window.innerHeight-e-t-(l.isSmall()?20:30)+"px",o.css("height",e),o.css("max-height",e),!1!==i&&r.scrollToBottom(),n())},100)})},u.prototype.getListNode=function(){return this.$.find(".conversation-entry-list")},u.prototype.onUpdate=function(){l.isLarge()&&this.getListNode().getNiceScroll().resize()},r.export=u}),humhub.module("mail.ConversationEntry",function(t,e,n){e=e("ui.widget").Widget.extend();e.prototype.replace=function(t){var e=this,o=n(t).hide();this.$.fadeOut(function(){n(this).replaceWith(o),e.$=o,e.$.fadeIn("slow")})},e.prototype.remove=function(){this.$.fadeToggle("slow",function(){n(this).remove()})},t.export=e}),humhub.module("mail.inbox",function(i,t,r){var e=t("ui.widget").Widget,o=t("ui.filter").Filter,n=t("ui.view"),s=t("ui.loader"),a=t("client"),t=o.extend(),o=(t.prototype.triggerChange=function(){this.super("triggerChange"),this.updateFilterCount()},t.prototype.updateFilterCount=function(){var t=this.getActiveFilterCount(),e=this.$.find("#conversation-filter-link"),o=e.find(".filterCount");t?(o=o.length?o:r('<small class="filterCount"></small>').insertBefore(e.find(".caret"))).html(" <b>("+t+")</b> "):o.length&&o.remove()},e.extend());o.prototype.init=function(){this.filter=e.instance("#mail-filter-root"),this.initScroll(),this.initHeight();var t=this;this.filter.off("afterChange.inbox").on("afterChange.inbox",function(){t.reload().then(function(){t.updateActiveItem()})}),n.isLarge()&&this.$.niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:3,left:0,bottom:0}}),this.$.on("click",".entry",function(){t.$.find(".entry").removeClass("selected"),r(this).addClass("selected")})},o.prototype.initHeight=function(){var t=this.$.offset().top;this.$.css("max-height",window.innerHeight-t-15+"px")},o.prototype.updateEntries=function(t){var o=this;t.length&&a.get(this.options.updateEntriesUrl,{data:{ids:t}}).then(function(t){t.result&&(r.each(t.result,function(t,e){t=o.getEntry(t);t.length?t.replaceWith(e):r(e).prependTo(o.$)}),o.updateActiveItem())}).catch(function(t){i.log.error(t)})},o.prototype.getEntry=function(t){return this.$.find('[data-message-id="'+t+'"]')},o.prototype.initScroll=function(){var t,e,o;window.IntersectionObserver&&(t=r('<div class="inbox-stream-end"></div>'),this.$.append(t),e=this,o=new IntersectionObserver(function(t){e.preventScrollLoading()||t.length&&t[0].isIntersecting&&(s.append(e.$),e.loadMore().finally(function(){s.reset(e.$)}))},{root:this.$[0],rootMargin:"50px"}),this.assureScroll().then(function(){o.observe(t[0])}))},o.prototype.assureScroll=function(){var t=this;return this.$[0].offsetHeight>=this.$[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()}):Promise.resolve()},o.prototype.loadMore=function(){var n=this;return new Promise(function(e,o){var t=n.filter.getFilterMap();t.from=n.getLastMessageId(),a.get(n.options.loadMoreUrl,{data:t}).then(function(t){t.result&&(r(t.result).insertBefore(".inbox-stream-end"),n.$.find(".inbox-stream-end").append()),n.options.isLast=!t.result||t.isLast,n.updateActiveItem(),e()}).catch(function(t){i.log.error(t,!0),o()}).finally(function(){n.scrollLock=!1})})},o.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},o.prototype.canLoadMore=function(){return!this.options.isLast},o.prototype.getReloadOptions=function(){return{data:this.filter.getFilterMap()}},o.prototype.updateActiveItem=function(){var t=e.instance("#mail-conversation-root").getActiveMessageId(),t=(this.$.find(".entry").removeClass("selected"),this.$.find(".entry").removeClass("selected"),this.$.find('[data-message-id="'+t+'"]'));t.length&&t.removeClass("unread").addClass("selected")},o.prototype.getFirstMessageId=function(){return this.$.find(".entry:first").data("message-id")},o.prototype.getLastMessageId=function(){return this.$.find(".entry:last").data("message-id")},o.prototype.hide=function(){return new Promise(function(t){n.isSmall()&&r(".mail-conversation-single-message").length&&r(".inbox-wrapper").slideUp(function(){r("#mail-conversation-root").length&&e.instance("#mail-conversation-root").updateSize(),t()}),t()})},o.prototype.show=function(){return new Promise(function(t){n.isSmall()&&r(".inbox-wrapper").slideDown(function(){r("#mail-conversation-root").length&&e.instance("#mail-conversation-root").updateSize(),t()}),t()})};i.export({ConversationList:o,Filter:t,setTagFilter:function(t){e.instance("#inbox").show().then(function(){r("#mail-filter-menu").collapse("show"),e.instance("#inbox-tag-picker").setSelection([{id:t.$trigger.data("tagId"),text:t.$trigger.data("tagName"),image:t.$trigger.data("tagImage")}])})},toggleInbox:function(){n.isSmall()&&r(".inbox-wrapper").slideToggle(function(){e.instance("#mail-conversation-root").updateSize()})}})}),humhub.module("mail.conversation",function(n,t,r){function i(t){return s.instance('.mail-conversation-entry[data-entry-id="'+t+'"]')}var s=t("ui.widget").Widget,a=t("ui.modal"),o=t("client"),e=t("event"),c=t("mail.notification");n.export({init:function(){e.on("humhub:modules:mail:live:NewUserMessage",function(t,e){var o,n,i;r("#inbox").length&&(o=s.instance("#mail-conversation-root"),n=!1,i=[],e.forEach(function(t){i.push(t.data.message_id),!n&&o&&o.options.messageId==t.data.message_id&&(o.loadUpdate(),n=!0,o.markSeen(t.data.message_id))}),s.instance("#inbox").updateEntries(i))}).on("humhub:modules:mail:live:UserMessageDeleted",function(t,e,o){r("#inbox").length&&e.forEach(function(t){var e=i(t.data.entry_id);e&&e.remove(),c.setMailMessageCount(t.data.count)})})},leave:function(t){o.post(t).then(function(t){t.redirect&&o.pjax.redirect(t.redirect)}).catch(function(t){n.log.error(t,!0)})},submitEditEntry:function(o){a.submit(o).then(function(t){var e;t.success?(e=i(o.$trigger.data("entry-id")))&&setTimeout(function(){e.replace(t.content)},300):n.log.error(null,!0)}).catch(function(t){n.log.error(t,!0)})},deleteEntry:function(t){var e=i(t.$trigger.data("entry-id"));e?o.post(e.options.deleteUrl).then(function(t){a.global.close(),t.success&&setTimeout(function(){e.remove()},1e3)}).catch(function(t){n.log.error(t,!0)}):n.log.error(null,!0)}})});