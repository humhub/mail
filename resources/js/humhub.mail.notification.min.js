humhub.module("mail.notification",function(n,e,t){function s(){o.get(n.config.url.count).then(function(e){d(parseInt(e.newMessages))})}var a,o=e("client"),i=e("ui.loader"),u=e("event"),l=e("ui.widget").Widget,r=0,d=(n.initOnPjaxLoad=!0,function(e){var n=t("#badge-messages");e&&0!==parseInt(e)?(r=e,n.empty(),n.append(e),n.fadeIn("fast")):(n.css("display","none"),r=0),u.trigger("humhub:modules:notification:UpdateTitleNotificationCount")});n.export({init:function(e){e||(u.on("humhub:modules:mail:live:NewUserMessage",function(e,n){n=n[n.length-1];d(n.data.count)}).on("humhub:modules:mail:live:UserMessageDeleted",function(e,n){n=n[n.length-1];d(n.data.count)}),t("#icon-messages").click(function(){a&&a.abort(),t("#loader_messages").parent().find(":not(#loader_messages)").remove(),i.set(t("#loader_messages").show()),o.get(n.config.url.list,{beforeSend:function(e){a=e}}).then(function(e){a=void 0,t("#loader_messages").parent().prepend(t(e.html)),t("#loader_messages").hide()})})),s()},loadMessage:function(e){var n=l.instance("#mail-conversation-root");n?(n.loadMessage(e),n.$.closest(".container").addClass("mail-conversation-single-message")):o.redirect(e.url),e.finish()},setMailMessageCount:d,updateCount:s,getNewMessageCount:function(){return r}})});